<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Library &mdash; Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture" href="index.html" />
    <link rel="prev" title="Optimization" href="opt.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Library</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="opt.html">Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="library">
<span id="sec-lib"></span><h1>Library<a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#compiler-rt" id="id7">Compiler-rt</a></li>
<li><a class="reference internal" href="#avr-libc" id="id8">Avr libc</a></li>
<li><a class="reference internal" href="#software-float-point-support" id="id9">Software Float Point Support</a></li>
</ul>
</div>
<p>Since Cpu0 has not hardware float point instructions, it needs soft float point
library to finish the floating point operation. LLVM compiler-rt project include
the software floating point library implementation, so we choose it as the
implementation.</p>
<p>Since compiler-rt uses unix/linux rootfs structure, we fill the gap by porting
avr libc.</p>
<p>Both the compiler-rt and avr libc porting is under going, it&#8217;s not finished.
The flow as follows,</p>
<div class="figure align-center" id="lib-f-flow">
<a class="reference internal image-reference" href="_images/11.png"><img alt="_images/11.png" src="_images/11.png" /></a>
<p class="caption">Figure 1: libc/softfloat library flow</p>
</div>
<p>The llvm-link which introduced at last chapter can be hired for optimization.</p>
<div class="section" id="compiler-rt">
<h2><a class="toc-backref" href="#id7">Compiler-rt</a><a class="headerlink" href="#compiler-rt" title="Permalink to this headline">¶</a></h2>
<p>Directory libex/libsoftfloat/compiler-rt include the floating point library
support for Cpu0 backend. The compiler-rt <a class="footnote-reference" href="#id6" id="id1">[1]</a> version we use is
llvm 3.5 release.</p>
</div>
<div class="section" id="avr-libc">
<h2><a class="toc-backref" href="#id8">Avr libc</a><a class="headerlink" href="#avr-libc" title="Permalink to this headline">¶</a></h2>
<p>Directory libex/libc/avr-libc-1.8.1 include the libc porting.</p>
<p>AVR Libc is a Free Software project whose goal is to provide a high quality C
library for use with GCC on Atmel AVR microcontrollers. AVR Libc is licensed
under a single unified license. This so-called modified Berkeley license is
intented to be compatible with most Free Software licenses like the GPL, yet
impose as little restrictions for the use of the library in closed-source
commercial applications as possible <a class="footnote-reference" href="#avr-libc-license" id="id2">[2]</a>.</p>
<p>The source code can be download from here <a class="footnote-reference" href="#avr-libc-download" id="id3">[3]</a>.
Document are here <a class="footnote-reference" href="#avr-libc-doc-web" id="id4">[4]</a> <a class="footnote-reference" href="#avr-libc-doc-pdf" id="id5">[5]</a>.</p>
</div>
<div class="section" id="software-float-point-support">
<h2><a class="toc-backref" href="#id9">Software Float Point Support</a><a class="headerlink" href="#software-float-point-support" title="Permalink to this headline">¶</a></h2>
<p class="rubric">exlbt/input/ch_float.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;debug.h&quot;</span>

<span class="cp">#define SINGLE_PRECISION</span>
<span class="cp">#include &quot;fp_lib.h&quot;</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">__fixsfsi</span><span class="p">(</span><span class="kt">fp_t</span> <span class="n">a</span><span class="p">);</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">__fixdfsi</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">test_longlong_shift1</span><span class="p">();</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">test_longlong_shift2</span><span class="p">();</span>

<span class="cp">#include &quot;print.cpp&quot;</span>

<span class="kt">int</span> <span class="nf">test_float_to_int</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="n">si_int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">__fixsfsi</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// work</span>
<span class="kt">int</span> <span class="nf">test_double_to_int</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.2</span><span class="p">;</span>
  <span class="n">si_int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">__fixdfsi</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;int_lib.h&quot;</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>

<span class="kt">int</span> <span class="nf">test_float_add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span> <span class="c1">// 1</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_float_mul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.3</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">);</span> <span class="c1">// 31.218=31</span>

  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_float_div</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">);</span> <span class="c1">// -6</span>

  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_double_to_int_2</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">b</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_double_add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_double_mul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">4.3</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">);</span> <span class="c1">// -31.218=-31</span>

  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_double_div</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.2</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">;</span>
  
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">);</span> <span class="c1">// -6</span>

  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">//extern &quot;C&quot; di_int __addvdi3(di_int a, di_int b);</span>
<span class="c">extern &quot;C&quot; di_int __addvdi3(long long a, long long b);</span>

<span class="c">//int test__addvdi3(di_int a, di_int b)</span>
<span class="c">int test__addvdi3(long long a, long long b)</span>
<span class="c">{</span>
<span class="c">    di_int x = __addvdi3(a, b);</span>
<span class="c">    di_int expected = a + b;</span>
<span class="c">    if (x != expected)</span>
<span class="c">        printf(&quot;error in test__addvdi3(0x%llX, 0x%llX) = %lld, expected %lld\n&quot;,</span>
<span class="c">                a, b, x, expected);</span>
<span class="c">    return x != expected;</span>
<span class="c">}</span>

<span class="c">int test_addvdi3()</span>
<span class="c">{</span>
<span class="c">//     test__addvdi3(0x8000000000000000LL, -1);  // should abort</span>
<span class="c">//     test__addvdi3(-1, 0x8000000000000000LL);  // should abort</span>
<span class="c">//     test__addvdi3(1, 0x7FFFFFFFFFFFFFFFLL);  // should abort</span>
<span class="c">//     test__addvdi3(0x7FFFFFFFFFFFFFFFLL, 1);  // should abort</span>

<span class="c">    if (test__addvdi3(0x8000000000000000LL, 1))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(1, 0x8000000000000000LL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(0x8000000000000000LL, 0))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(0, 0x8000000000000000LL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(0x7FFFFFFFFFFFFFFLL, -1))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(-1, 0x7FFFFFFFFFFFFFFLL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(0x7FFFFFFFFFFFFFFFLL, 0))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__addvdi3(0, 0x7FFFFFFFFFFFFFFFLL))</span>
<span class="c">        return 1;</span>

<span class="c">    return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">di_int</span> <span class="n">__absvdi2</span><span class="p">(</span><span class="n">di_int</span> <span class="n">a</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">test__absvdi2</span><span class="p">(</span><span class="n">di_int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">di_int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">__absvdi2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">di_int</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expected</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="n">expected</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">expected</span> <span class="o">||</span> <span class="n">expected</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error in __absvdi2(0x%08X%08X) = %08d%08d, expected positive %08d%08d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span><span class="p">(</span><span class="n">expected</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">expected</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_absvdi2</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">//     if (test__absvdi2(0x8000000000000000LL))  // should abort</span>
<span class="c1">//         return 1;</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x0000000000000000LL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x0000000000000001LL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x0000000000000002LL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x7FFFFFFFFFFFFFFELL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x7FFFFFFFFFFFFFFFLL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x8000000000000001LL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0x8000000000000002LL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0xFFFFFFFFFFFFFFFELL</span><span class="p">);</span>
    <span class="n">test__absvdi2</span><span class="p">(</span><span class="mh">0xFFFFFFFFFFFFFFFFLL</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">test__absvdi2</span><span class="p">(((</span><span class="n">di_int</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">si_int</span> <span class="n">__absvsi2</span><span class="p">(</span><span class="n">si_int</span> <span class="n">a</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">test__absvsi2</span><span class="p">(</span><span class="n">si_int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">si_int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">__absvsi2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">si_int</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expected</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="n">expected</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">expected</span> <span class="o">||</span> <span class="n">expected</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error in __absvsi2(0x%X) = %d, expected positive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">expected</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_absvsi2</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">//     if (test__absvsi2(0x80000000))  // should abort</span>
<span class="c1">//         return 1;</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x00000002</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x7FFFFFFE</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x7FFFFFFF</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x80000001</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0x80000002</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0xFFFFFFFE</span><span class="p">);</span>
    <span class="n">test__absvsi2</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">test__absvsi2</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define CRT_HAS_128BIT</span>

<span class="cp">#ifdef CRT_HAS_128BIT</span>

<span class="c">// Returns: absolute value</span>

<span class="c">// Effects: aborts if abs(x) &lt; 0</span>

<span class="c">extern &quot;C&quot; ti_int __absvti2(ti_int a);</span>

<span class="c">int test__absvti2(ti_int a)</span>
<span class="c">{</span>
<span class="c">    ti_int x = __absvti2(a);</span>
<span class="c">    ti_int expected = a;</span>
<span class="c">    if (expected &lt; 0)</span>
<span class="c">        expected = -expected;</span>
<span class="c">    if (x != expected || expected &lt; 0)</span>
<span class="c">    {</span>
<span class="c">        twords at;</span>
<span class="c">        at.all = a;</span>
<span class="c">        twords xt;</span>
<span class="c">        xt.all = x;</span>
<span class="c">        twords expectedt;</span>
<span class="c">        expectedt.all = expected;</span>
<span class="c">        printf(&quot;error in __absvti2(0x%8X%8X.%8X%8X) = &quot;</span>
<span class="c">               &quot;0x%8X%8X%.8X%.8X, expected positive 0x%8X%8X%.8X%.8X\n&quot;,</span>
<span class="c">               (int)(at.s.high&gt;&gt;32), (int)(at.s.high), (int)(at.s.low&gt;&gt;32), </span>
<span class="c">               (int)(at.s.low), (int)(xt.s.high&gt;&gt;32), (int)(xt.s.high), </span>
<span class="c">               (int)(xt.s.low&gt;&gt;32), (int)(xt.s.low),</span>
<span class="c">               (int)(expectedt.s.high&gt;&gt;32), (int)(expectedt.s.high), </span>
<span class="c">               (int)(expectedt.s.low&gt;&gt;32), (int)(expectedt.s.low));</span>
<span class="c">    }</span>
<span class="c">    return x != expected;</span>
<span class="c">}</span>

<span class="cp">#endif</span>

<span class="c">int test_absvti2()</span>
<span class="c">{</span>
<span class="cp">#ifdef CRT_HAS_128BIT</span>

<span class="c">//     if (test__absvti2(make_ti(0x8000000000000000LL, 0)))  // should abort</span>
<span class="c">//         return 1;</span>
<span class="c">    if (test__absvti2(0x0000000000000000LL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(0x0000000000000001LL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(0x0000000000000002LL))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0x7FFFFFFFFFFFFFFFLL, 0xFFFFFFFFFFFFFFFELL)))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0x7FFFFFFFFFFFFFFFLL, 0xFFFFFFFFFFFFFFFFLL)))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0x8000000000000000LL, 0x0000000000000001LL)))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0x8000000000000000LL, 0x0000000000000002LL)))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0xFFFFFFFFFFFFFFFFLL, 0xFFFFFFFFFFFFFFFELL)))</span>
<span class="c">        return 1;</span>
<span class="c">    if (test__absvti2(make_ti(0xFFFFFFFFFFFFFFFFLL, 0xFFFFFFFFFFFFFFFFLL)))</span>
<span class="c">        return 1;</span>

<span class="c">    int i;</span>
<span class="c">    for (i = 0; i &lt; 10000; ++i)</span>
<span class="c">        if (test__absvti2(make_ti(((ti_int)i &lt;&lt; 32) | i,</span>
<span class="c">                                  ((ti_int)i &lt;&lt; 32) | i)))</span>
<span class="c">            return 1;</span>
<span class="cp">#else</span>
<span class="c">    printf(&quot;skipped\n&quot;);</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">test_longlong_shift1</span><span class="p">();</span> <span class="c1">// 0x121 = 289</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_longlong_shift1() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_longlong_shift2</span><span class="p">();</span> <span class="c1">// 0x16 = 22</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_longlong_shift2() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_float_to_int</span><span class="p">();</span> <span class="c1">// -2</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_float_to_int() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_double_to_int</span><span class="p">();</span> <span class="c1">// -4</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_double_to_int() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_double_to_int_2</span><span class="p">();</span> <span class="c1">// 3</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_double_to_int_2() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_float_add</span><span class="p">();</span> <span class="c1">// 1</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_float_add() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_float_mul</span><span class="p">();</span> <span class="c1">// 31</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_float_mul() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_float_div</span><span class="p">();</span> <span class="c1">// -6</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_float_div() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_double_add</span><span class="p">();</span> <span class="c1">// 5</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_double_add() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_double_mul</span><span class="p">();</span> <span class="c1">// -31</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_double_mul() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_double_div</span><span class="p">();</span> <span class="c1">// -6</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_double_div() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  test_addvdi3();</span>
<span class="cp">#endif</span>
  <span class="n">test_absvdi2</span><span class="p">();</span>
  <span class="n">test_absvsi2</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">exlbt/input/build-float.sh</p>
<div class="highlight-c++"><pre>#!/usr/bin/env bash

INCFLAG="-I../libsoftfloat/compiler-rt/builtins"

source functions.sh

sh_name=build-float.sh
argNum=$#
arg1=$1
arg2=$2

prologue;

libsf=../libsoftfloat/compiler-rt
pushd ${libsf}
bash build.sh
popd
olibsf=${libsf}/obj

clang -target mips-unknown-linux-gnu -c start.cpp -emit-llvm -o start.bc
clang -target mips-unknown-linux-gnu -c debug.cpp -emit-llvm -o debug.bc
clang -target mips-unknown-linux-gnu -c printf-stdarg-def.c -emit-llvm \
-o printf-stdarg-def.bc
clang -target mips-unknown-linux-gnu -c printf-stdarg.c -emit-llvm \
-o printf-stdarg.bc
clang $INCFLAG -c ch_float.cpp -emit-llvm -o ch_float.bc
clang $INCFLAG -c ${LBDEXDIR}/input/ch9_7.cpp -emit-llvm -o ch9_7.bc
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj start.bc -o start.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj debug.bc -o debug.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj printf-stdarg-def.bc -o printf-stdarg-def.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj printf-stdarg.bc -o printf-stdarg.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj ch9_7.bc -o ch9_7.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj ch_float.bc -o ch_float.cpu0.o
${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
-filetype=obj lib_cpu0.ll -o lib_cpu0.o
${TOOLDIR}/lld -flavor gnu -target cpu0${endian}-unknown-linux-gnu \
  -o a.out start.cpu0.o debug.cpu0.o printf-stdarg-def.cpu0.o printf-stdarg.cpu0.o \
  ch_float.cpu0.o ch9_7.cpu0.o lib_cpu0.o \
  ${olibsf}/libFloat.o
#  ${olibsf}/fixsfsi.o ${olibsf}/fixsfdi.o ${olibsf}/fixdfsi.o \
#  ${olibsf}/addsf3.o ${olibsf}/mulsf3.o ${olibsf}/divsf3.o \
#  ${olibsf}/adddf3.o ${olibsf}/muldf3.o ${olibsf}/divdf3.o \
#  ${olibsf}/ashrdi3.o ${olibsf}/ashldi3.o ${olibsf}/lshrdi3.o \
#  ${olibsf}/extendsfdf2.o ${olibsf}/truncdfsf2.o


epilogue;

</pre>
</div>
<p>Run as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>bash build-float.sh cpu032II be
...
<span class="nv">endian</span> <span class="o">=</span>  BigEndian
0   /* 0: big endian, 1: little endian */

JonathantekiiMac:input Jonathan<span class="nv">$ </span>iverilog -o cpu0IIs cpu0IIs.v
JonathantekiiMac:input Jonathan<span class="nv">$ </span>./cpu0IIs
114-43-184-210:verilog Jonathan<span class="nv">$ </span>./cpu0IIs
WARNING: ./cpu0.v:458: <span class="nv">$readmemh</span><span class="o">(</span>cpu0.hex<span class="o">)</span>: Not enough words in the file <span class="k">for</span>
the requested range <span class="o">[</span>0:524287<span class="o">]</span>.
taskInterrupt<span class="o">(</span>001<span class="o">)</span>
test_longlong_shift1<span class="o">()</span> <span class="o">=</span> 289
test_longlong_shift2<span class="o">()</span> <span class="o">=</span> 22
test_float_to_int<span class="o">()</span> <span class="o">=</span> -2
test_double_to_int<span class="o">()</span> <span class="o">=</span> -4
test_double_to_int_2<span class="o">()</span> <span class="o">=</span> 3
test_float_add<span class="o">()</span> <span class="o">=</span> 1
test_float_mul<span class="o">()</span> <span class="o">=</span> 31
test_float_div<span class="o">()</span> <span class="o">=</span> -6
test_double_add<span class="o">()</span> <span class="o">=</span> 5
test_double_mul<span class="o">()</span> <span class="o">=</span> -31
test_double_div<span class="o">()</span> <span class="o">=</span> -6
total cpu <span class="nv">cycles</span> <span class="o">=</span> 104105
RET to PC &lt; 0, finished!
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://compiler-rt.llvm.org/">http://compiler-rt.llvm.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="avr-libc-license" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://www.nongnu.org/avr-libc/">http://www.nongnu.org/avr-libc/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="avr-libc-download" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://download.savannah.gnu.org/releases/avr-libc/">http://download.savannah.gnu.org/releases/avr-libc/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="avr-libc-doc-web" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="http://www.atmel.com/webdoc/AVRLibcReferenceManual/index.html">http://www.atmel.com/webdoc/AVRLibcReferenceManual/index.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="avr-libc-doc-pdf" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="http://courses.cs.washington.edu/courses/csep567/04sp/pdfs/avr-libc-user-manual.pdf">http://courses.cs.washington.edu/courses/csep567/04sp/pdfs/avr-libc-user-manual.pdf</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="opt.html">Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>